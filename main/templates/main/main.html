{% extends 'main/base.html' %}
{% load static %}

{% block meta %}
  <title>Welcome - Beyond The Game</title>
{% endblock meta %}

{% block hero %}
<section class="hero-section">
  <div class="video-background">
    <video autoplay muted loop playsinline id="hero-video">
      <source src="{% static 'videos/hero-video.webm' %}" type="video/webm">
      <source src="{% static 'videos/hero-video.mp4' %}" type="video/mp4">
    </video>
  </div>

  <div class="hero-content">
    <h1 class="main-title">Where Every Piece Tells a Story</h1>
    <a href="#collection-section" class="explore-link">Explore Our Pieces</a>
  </div>

  <a href="#collection-section" class="scroll-down-arrow" style="position: absolute; bottom: 30px; z-index: 3; font-size: 1.5rem; color: white;">
    <i class="fa-solid fa-chevron-down"></i>
  </a>
</section>
{% endblock hero %}

{% block content %}
<section id="collection-section" class="product-page-container scroll-target">
  <h1 class="page-title">The Collection</h1>
  
  <nav class="product-filter-nav">
    <a href="#" data-filter="all">All Products</a>
    <a href="#" data-filter="mine">My Products</a>
    <button id="add-product-btn" type="button" data-add-url="{% url 'main:add_product' %}">+ Add Product</button>
  </nav>

  <div id="product-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-8"></div>
</section>

<!-- Modal -->
<div id="form-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
    <div class="flex justify-between items-center border-b pb-3 mb-4">
        <h2 id="modal-title" class="text-xl font-semibold">Modal Title</h2>
        <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<div class="flex justify-end mb-3">
  <button id="refresh-products"
          data-refresh-url="{% url 'main:product_list_partial' %}"
          class="bg-blue-500 text-white px-3 py-2 rounded-lg shadow">
    Refresh
  </button>
</div>


<!-- HTMX -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<!-- Script interaksi -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const addBtn = document.getElementById("add-product-btn");
  const modal = document.getElementById("form-modal");
  const closeBtn = document.getElementById("close-modal-btn");
  const modalBody = document.getElementById("modal-body");
  const modalTitle = document.getElementById("modal-title");

  addBtn.addEventListener("click", function () {
    const url = this.dataset.addUrl;
    modalTitle.textContent = "Add Product";
    modal.classList.remove("hidden");
    modal.classList.add("flex");
    htmx.ajax('GET', url, { target: "#modal-body" });
  });

  closeBtn.addEventListener("click", function () {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  });

  modal.addEventListener("click", function (e) {
    if (e.target === modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }
  });

  document.body.addEventListener("htmx:afterRequest", function (evt) {
    // Cek jika ID formnya adalah 'product-form' ATAU 'edit-product-form'
    if ((evt.detail.target.id === "product-form" || evt.detail.target.id === "edit-product-form") && evt.detail.successful) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      // Menampilkan pesan toast yang sesuai
      if (evt.detail.target.id === "product-form") {
          showToast("Product added!", "success");
      } else {
          showToast("Product updated!", "success");
      }
      htmx.ajax('GET', "{% url 'main:product_list_partial' %}", { target: "#product-container" });
    }
  });

  document.body.addEventListener("click", async (evt) => {
    const btn = evt.target.closest(".delete-btn");
    if (!btn) return;
    if (confirm("Are you sure you want to delete this product?")) {
      const id = btn.dataset.id;
      const response = await fetch(`/api/products/${id}/delete/`, {
        method: "DELETE",
        headers: { "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value },
      });
      const data = await response.json();
      if (data.status === "success") {
        showToast("Product deleted!", "success");
        htmx.ajax('GET', "{% url 'main:product_list_partial' %}", { target: "#product-container" });
      } else {
        showToast("Error deleting: " + data.message, "error");
      }
    }
  });

  // Listener ini menangani semua tombol dengan class 'cancel-modal-btn'
  document.body.addEventListener('click', function(e) {
      if (e.target.classList.contains('cancel-modal-btn')) {
          const modal = document.getElementById('form-modal');
          if (modal) {
              modal.classList.add('hidden');
              modal.classList.remove('flex');
          }
      }
  });

});

function showToast(message, type = "info") {
  let container = document.getElementById("toast-container");
  if (!container) {
    container = document.createElement("div");
    container.id = "toast-container";
    container.className = "fixed bottom-5 right-5 z-50 space-y-2";
    document.body.appendChild(container);
  }
  const toast = document.createElement("div");
  toast.textContent = message;
  toast.className = `px-4 py-2 rounded-lg shadow-lg text-white ${
    type === "success" ? "bg-green-500" : type === "error" ? "bg-red-500" : "bg-gray-700"
  }`;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 2500);
}
</script>

{% endblock content %}